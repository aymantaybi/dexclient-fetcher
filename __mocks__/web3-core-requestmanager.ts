const errors = require("web3-core-helpers").errors;
const Jsonrpc = require("web3-core-requestmanager/src/jsonrpc.js");
const { callbackify } = require("util");

const originalModule = jest.requireActual("web3-core-requestmanager");

const { Manager, BatchManager } = originalModule;

const blockExemple = {
  jsonrpc: "2.0",
  id: 1276301395270008,
  result: {
    difficulty: "0x7",
    extraData:
      "0xd683020400846765746886676f312e3137856c696e7578000000000000000000c936002ea90d8ad1bd29edd4175d982d87d7f040b155ca7ff9eb28fd353409f97489f87cbe339822d0ed551438ba05aedde81fe1c67c7e7b8215de39c17a089800",
    gasLimit: "0x5f46389",
    gasUsed: "0x11b717",
    hash: "0x452c5e581b92706a81f20743ff60794331d2419f73ff81cdb7c25b4d9e8603a0",
    logsBloom:
      "0x0020000018080000040040008841000000080000100401000001000400000000800084008800000000200000000000000108400010000000010000000008200c1002c00000000000000208080300002010048400000000000000004000000002820004000400000000400000080000000000100008000000802400101000000003000004040000000002000200001803b0080000002000080000004010100200108004000080100000000000400000000000000000000002001000000200000008008802000100000050000080000004000000000208001010040000000000000208200804002010000022020000000000002200010000000020084500040400",
    miner: "0xfc3e31519b551bd594235dd0ef014375a87c4e21",
    mixHash: "0x0000000000000000000000000000000000000000000000000000000000000000",
    nonce: "0x0000000000000000",
    number: "0x140ef11",
    parentHash: "0xbd86a560cd1358150939ff2a5773b041dbff8190f6da4d66730b41f98635cd8c",
    receiptsRoot: "0xbe39e208a51780f3730da4174db4df740a85cd77eea1eed2e983d6aa87192db2",
    sha3Uncles: "0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347",
    size: "0x1018",
    stateRoot: "0x9052c62a4c8047d525e6a9dcfcc7ce9caea3fc6639d95b25848af61e4b6a1243",
    timestamp: "0x63d4584c",
    totalDifficulty: "0x8a481fa",
    transactions: [
      {
        blockHash: "0x452c5e581b92706a81f20743ff60794331d2419f73ff81cdb7c25b4d9e8603a0",
        blockNumber: "0x140ef11",
        from: "0x1d3286a3348fa99852d147c57a79045b41c4f713",
        gas: "0x16e360",
        gasPrice: "0x4ae0da900",
        hash: "0xfcb078d06c11d8787fce80d643c485e575d317a09cd6ff1b4f2bfe9998c46431",
        input:
          "0x38ed17390000000000000000000000000000000000000000000000000aca04d9fe7b198f000000000000000000000000000000000000000000000005e14e2ce1ab10a34300000000000000000000000000000000000000000000000000000000000000a00000000000000000000000001d3286a3348fa99852d147c57a79045b41c4f7130000000000000000000000000000000000000000000000000000000063d45a9e0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000c99a6a985ed2cac1ef41640596c5a5f9f4e19ef500000000000000000000000097a9107c1793bc407d6f527b77e7fff4d812bece",
        nonce: "0xf045",
        to: "0x7d0556d55ca1a92708681e2e231733ebd922597d",
        transactionIndex: "0x0",
        value: "0x0",
        type: "0x0",
        v: "0xfeb",
        r: "0x6bcb000e01d4059a3d572f05d04b447fdc6cd87238306fadb336585245a9b68",
        s: "0x78c62a2b264c37908acd8ed0829dcbf64cddd649c50187583e1694ffedd1faf6",
      },
      {
        blockHash: "0x452c5e581b92706a81f20743ff60794331d2419f73ff81cdb7c25b4d9e8603a0",
        blockNumber: "0x140ef11",
        from: "0xa71be2d42b913c06ef915ceaf35ac14b524c7073",
        gas: "0x60d53",
        gasPrice: "0x4a817c800",
        hash: "0x418d0cd2824c76383298e05699a6de7ade3ae793a92859948d001e53519c0d3d",
        input:
          "0x95a4ec0000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000e4f524445525f45584348414e474500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003e477a1de8b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e7f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000063d45f4600000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000002000000000000000000000000a8754b9fa15fc18bb59458815510e40a12cd2014000000000000000000000000c99a6a985ed2cac1ef41640596c5a5f9f4e19ef50000000000000000000000000000000000000000000000000000000000000041d96346cdb624e0b714df4cc0edc9b0f85bff43377fb22f1294181d4ea09eb4194bec47a74d746b5bc66053d94a731df1ec07aa5fd397fb8040795e3894f9c69a1b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000ac6d40a954aa179a2870e696731a203ace0a7509000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000064c2a97b000000000000000000000000c99a6a985ed2cac1ef41640596c5a5f9f4e19ef50000000000000000000000000000000000000000000000000000000063d409fb000000000000000000000000000000000000000000000000001a4a42c3568000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001a900000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000814a9c959a3ef6ca44b5e2349e3bba984539394700000000000000000000000000000000000000000000000000000000001e8c84000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000",
        nonce: "0x92e",
        to: "0xfff9ce5f71ca6178d3beecedb61e7eff1602950e",
        transactionIndex: "0x1",
        value: "0x0",
        type: "0x0",
        v: "0xfeb",
        r: "0xb69a100ef55113e45dd3343f63828ea259ed1b6d675d491aca63db09c7629f15",
        s: "0x2fe1a580b95e84871d2938732ccdd1d0232adbb5a9b89d1a116e6dc825761e91",
      },
      {
        blockHash: "0x452c5e581b92706a81f20743ff60794331d2419f73ff81cdb7c25b4d9e8603a0",
        blockNumber: "0x140ef11",
        from: "0x9976417938dd5035a1866ce01f7cc3efae24e1c4",
        gas: "0x67c10",
        gasPrice: "0x4a817c800",
        hash: "0x5a6f59d9660f07103c84b463ccd75f7ef906def7d7e15144169f2ca2128cf67f",
        input: "0x3d8527ba",
        nonce: "0xd5",
        to: "0x05b0bb3c1c320b280501b86706c3551995bc8571",
        transactionIndex: "0x2",
        value: "0x0",
        type: "0x0",
        v: "0xfec",
        r: "0x848bce105958b076c38bc1a4e9dbdbc8fb8dec8d86c0e294ed97ceaae8135c00",
        s: "0x7f047babdb4b60069f6656ff27b7af41dab2b795f7930746ae72ab146471ab37",
      },
      {
        blockHash: "0x452c5e581b92706a81f20743ff60794331d2419f73ff81cdb7c25b4d9e8603a0",
        blockNumber: "0x140ef11",
        from: "0x507eba0dddbfdf8891ee6b3652ccaaaeb8de43c0",
        gas: "0x25457",
        gasPrice: "0x4a817c800",
        hash: "0xf67a09dc555c7bc6384835c3a43669d8ad813c3c617c26565b086061066ae74c",
        input:
          "0x42842e0e000000000000000000000000507eba0dddbfdf8891ee6b3652ccaaaeb8de43c0000000000000000000000000e6a010326d1dd7daf4e3b7496e2aec778bd223d000000000000000000000000000000000000000000000000000000000007a0328",
        nonce: "0x16",
        to: "0x32950db2a7164ae833121501c797d79e7b79d74c",
        transactionIndex: "0x3",
        value: "0x0",
        type: "0x0",
        v: "0xfeb",
        r: "0x9484a15f4ae0c5066e650fbcfcc8159c06f5bd4901fa149ff711d66b9a72df5b",
        s: "0x28f04951120161cdd02dbef244092d4d5e797df81c1eed318e5eb8cb2712ff55",
      },
      {
        blockHash: "0x452c5e581b92706a81f20743ff60794331d2419f73ff81cdb7c25b4d9e8603a0",
        blockNumber: "0x140ef11",
        from: "0xc8c37be68de33c7c2d93f7c3f4dc4ac48caae8fc",
        gas: "0x3232f",
        gasPrice: "0x4a817c800",
        hash: "0xf7dcbb19b1030783d5a0db0b3e47f832bd81c638b79aa1008587ec9d7e5a1aa6",
        input:
          "0x95a4ec0000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000e4f524445525f45584348414e47450000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000344c54c66d300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011556cb5dbf000000000000000000000000000afd0f2c98d49087158721094539bd321e111320b00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000041816a5c9905716bc2dfbf11afaa0ae48123fa233f2075c77e509867ec2ad39b7a3f6ab7dfc6fbd532f37298dc2df65b6996014921ca47276c7612b64979f734371b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000e4e4bfc5e56507502f7a059a712e1a93b8671104000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000064c2ccef000000000000000000000000c99a6a985ed2cac1ef41640596c5a5f9f4e19ef50000000000000000000000000000000000000000000000000000000063d42d6f0000000000000000000000000000000000000000000000000011556cb5dbf000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001a900000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000814a9c959a3ef6ca44b5e2349e3bba984539394700000000000000000000000000000000000000000000000000000000001e8c8b000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000",
        nonce: "0x2ab",
        to: "0xfff9ce5f71ca6178d3beecedb61e7eff1602950e",
        transactionIndex: "0x4",
        value: "0x0",
        type: "0x0",
        v: "0xfec",
        r: "0x47b3d4eed2e7699892b2c91d78f09f089e0a47c3317396c8b1c3d987e612e00c",
        s: "0x3e85e78af748a91a3dd1ec4f301475bc4e04b5de5f457fe031ea8f885249f29f",
      },
      {
        blockHash: "0x452c5e581b92706a81f20743ff60794331d2419f73ff81cdb7c25b4d9e8603a0",
        blockNumber: "0x140ef11",
        from: "0x607f900dfbf99b75b624efd4ab1b4d763fcee258",
        gas: "0x17f6a",
        gasPrice: "0x4a817c800",
        hash: "0x764af8b5a9df88c3f2f45e5c2fa6f25a5dffa97e103b7dcd751710caa68f1e52",
        input:
          "0xa22cb465000000000000000000000000fff9ce5f71ca6178d3beecedb61e7eff1602950e0000000000000000000000000000000000000000000000000000000000000001",
        nonce: "0xb",
        to: "0x32950db2a7164ae833121501c797d79e7b79d74c",
        transactionIndex: "0x5",
        value: "0x0",
        type: "0x0",
        v: "0xfeb",
        r: "0x99ce05f0e42f9ed6973c9ca72eac4ead7b8a55eb57409f2769dff32e7f6f210d",
        s: "0x4b0fb03d11fd23b5369a0c3e9c499ab0a7c4971632131db8737ea9bdc91bb4dd",
      },
      {
        blockHash: "0x452c5e581b92706a81f20743ff60794331d2419f73ff81cdb7c25b4d9e8603a0",
        blockNumber: "0x140ef11",
        from: "0x46dca101393ca97f82359a1bf6a52d4954797502",
        gas: "0x21973",
        gasPrice: "0x4a817c800",
        hash: "0x083e652d519d4c9d389c36d94857733926875d3d02c279a90186abaae3cd6ade",
        input:
          "0x1c7a734d000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000a89d6e",
        nonce: "0x2ec",
        to: "0x20dad05af3f2663c652495f3e581b3fed926f39c",
        transactionIndex: "0x6",
        value: "0x0",
        type: "0x0",
        v: "0xfeb",
        r: "0x5be39647ce54304face4f5f76578f8d9630236a1aefc2cf1803a681430f4b699",
        s: "0x6489485fd649ffb88534b8f31c60c4ff00df9af84eb9e9cc6b84656a12762bb0",
      },
    ],
    transactionsRoot: "0x9d8327eedd0f7a9c7503e25372869759c2e6976f9979ebf2a65498890902bd88",
    uncles: [],
  },
};

Manager.prototype.sendBatch = function (data, callback) {
  //console.log(JSON.stringify(data, null, 4));
  //original implementation

  /* if (!this.provider) {
    return callback(errors.InvalidProvider());
  }
  var payload = Jsonrpc.toBatchPayload(data);
  this.provider[this.provider.sendAsync ? "sendAsync" : "send"](payload, function (err, results) {
    console.log(results);
    if (err) {
      return callback(err);
    }

    if (!Array.isArray(results)) {
      return callback(errors.InvalidResponse(results));
    }

    callback(null, results);
  }); */

  //mock implementation

  const results = data.map((request, index) => {
    const jsonrpc = "2.0";
    const id = index + 1;
    if (request.method == "eth_chainId") return { jsonrpc, id, result: "0x38" };
    if (request.method == "eth_call") {
      if (request.params[1] === "latest") {
        if (request.params[0].to === "0xa8754b9fa15fc18bb59458815510e40a12cd2014") {
          if (request.params[0].data === "0x95d89b41") {
            return {
              jsonrpc,
              id,
              result:
                "0x00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003534c500000000000000000000000000000000000000000000000000000000000",
            };
          }
          if (request.params[0].data === "0x313ce567") {
            return {
              jsonrpc,
              id,
              result: "0x0000000000000000000000000000000000000000000000000000000000000000",
            };
          }
        }
        if (request.params[0].to === "0xb72723e36a83fb5fe1793f06b436f4720f5de4f9") {
          if (request.params[0].data === "0x95d89b41") {
            return {
              jsonrpc,
              id,
              result:
                "0x0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000743616b652d4c5000000000000000000000000000000000000000000000000000",
            };
          }
          if (request.params[0].data === "0x0dfe1681") {
            return {
              jsonrpc,
              id,
              result: "0x0000000000000000000000008c851d1a123ff703bd1f9dabe631b69902df5f97",
            };
          }
          if (request.params[0].data === "0xd21220a7") {
            return {
              jsonrpc,
              id,
              result: "0x000000000000000000000000e9e7cea3dedca5984780bafc599bd69add087d56",
            };
          }
          if (request.params[0].data === "0x0902f1ac") {
            return {
              jsonrpc,
              id,
              result:
                "0x00000000000000000000000000000000000000000000218657d08ce319e12fb90000000000000000000000000000000000000000000b835219eb916cf62ccea60000000000000000000000000000000000000000000000000000000063d120c6",
            };
          }
        }
        if (request.params[0].to === "0x306a28279d04a47468ed83d55088d0dcd1369294") {
          if (request.params[0].data === "0x95d89b41") {
            return {
              jsonrpc,
              id,
              result:
                "0x00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000008534c502d57455448000000000000000000000000000000000000000000000000",
            };
          }
          if (request.params[0].data === "0x0dfe1681") {
            return {
              jsonrpc,
              id,
              result: "0x000000000000000000000000a8754b9fa15fc18bb59458815510e40a12cd2014",
            };
          }
          if (request.params[0].data === "0xd21220a7") {
            return {
              jsonrpc,
              id,
              result: "0x000000000000000000000000c99a6a985ed2cac1ef41640596c5a5f9f4e19ef5",
            };
          }
          if (request.params[0].data === "0x0902f1ac") {
            return {
              jsonrpc,
              id,
              result:
                "0x000000000000000000000000000000000000000000000000000000007839a53f0000000000000000000000000000000000000000000000dabc9302f03e1b176e0000000000000000000000000000000000000000000000000000000063d43bd7",
            };
          }
        }
      }
    }
  });
  callback(null, results);
};

Manager.prototype.send = function (data, callback) {
  //mock implementation

  if (data.method === "eth_chainId") {
    callback = callback || function () {};
    const { method, params } = data;
    const jsonrpcPayload = Jsonrpc.toPayload(method, params);
    const jsonrpcResultCallback = this._jsonrpcResultCallback(callback, jsonrpcPayload);
    jsonrpcResultCallback(null, { jsonrpc: "2.0", id: jsonrpcPayload.id, result: "0x7e4" });
    return;
  }
  if (data.method === "eth_subscribe") {
    return;
  }
  if (data.method === "eth_getBlockByNumber" && data.params[0] === "0x140ef11" && data.params[1] === true) {
    callback = callback || function () {};
    const { method, params } = data;
    const jsonrpcPayload = Jsonrpc.toPayload(method, params);
    const jsonrpcResultCallback = this._jsonrpcResultCallback(callback, jsonrpcPayload);
    jsonrpcResultCallback(null, { ...blockExemple, id: jsonrpcPayload.id });
    return;
  }
  if (data.method === "eth_call") {
    if (data.params[0].data === "0x70a08231000000000000000000000000c1eb47de5d549d45a871e32d9d082e7ac5d2e3ed") {
      callback = callback || function () {};
      const { method, params } = data;
      const jsonrpcPayload = Jsonrpc.toPayload(method, params);
      const jsonrpcResultCallback = this._jsonrpcResultCallback(callback, jsonrpcPayload);
      jsonrpcResultCallback(null, {
        jsonrpc: "2.0",
        id: jsonrpcPayload.id,
        result: "0x0000000000000000000000000000000000000000000000000000000000000004",
      });
      return;
    }
  }
  //original implementation
  callback = callback || function () {};
  if (!this.provider) {
    return callback(errors.InvalidProvider());
  }
  const { method, params } = data;
  const jsonrpcPayload = Jsonrpc.toPayload(method, params);
  const jsonrpcResultCallback = this._jsonrpcResultCallback(callback, jsonrpcPayload);
  if (this.provider.request) {
    const callbackRequest = callbackify(this.provider.request.bind(this.provider));
    const requestArgs = { method, params };
    callbackRequest(requestArgs, callback);
  } else if (this.provider.sendAsync) {
    this.provider.sendAsync(jsonrpcPayload, jsonrpcResultCallback);
  } else if (this.provider.send) {
    //console.log(jsonrpcPayload);
    this.provider.send(jsonrpcPayload, (error, data) => {
      //console.log(JSON.stringify(data));
      jsonrpcResultCallback(error, data);
    });
  } else {
    throw new Error("Provider does not have a request or send method to use.");
  }
};

export { Manager, BatchManager };
